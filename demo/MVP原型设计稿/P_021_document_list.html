<!-- START: P_021_document_list.html -->
<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>P_021 - æ–‡æ¡£åˆ—è¡¨é¡µ</title>
  <!-- Tailwind CSS & daisyUI -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* è§£å†³æ»šåŠ¨æ¡é—´éš™é—®é¢˜ */
    html { overflow-y: scroll; }
    /* å¼€å‘è€…æ³¨é‡ŠæŒ‰é’®çš„è‡ªå®šä¹‰æ ·å¼ */
    .dev-note-btn {
      position: absolute;
      transform: translate(50%, -50%); /* å¾®è°ƒä½ç½®ä½¿å…¶åœ¨å…ƒç´ è§’ä¸Š */
    }
    /* æ‰¹é‡æ“ä½œæ çš„å¹³æ»‘è¿‡æ¸¡ */
    #batchActionBar {
      transition: all 0.3s ease-in-out;
    }
    /* ä¿®å¤ä¸­æ–‡æ–‡æœ¬çºµå‘æ˜¾ç¤ºé—®é¢˜ */
    .dropdown-content li a {
      word-wrap: normal;
      word-break: keep-all;
      white-space: nowrap;
      min-width: max-content;
    }
    .dropdown-content {
      max-width: none;
    }
  </style>
</head>
<body class="bg-base-200 font-sans">

  <div class="p-4 sm:p-6 md:p-8 min-h-screen">
    <div class="max-w-full mx-auto">

      <!-- é¡µé¢å¤´éƒ¨ -->
      <header class="mb-6">
        <div class="text-sm breadcrumbs">
          <ul>
            <li><a>ğŸ çŸ¥è¯†åº“</a></li>
            <li><a>ğŸ“˜ äº§å“Aæ‰‹å†Œ</a></li>
          </ul>
        </div>
        <h1 class="text-3xl font-bold text-base-content mt-2">ğŸ“˜ äº§å“Aæ‰‹å†Œ</h1>
      </header>

      <!-- æ“ä½œä¸æœç´¢æ  -->
      <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
        <div class="form-control w-full md:w-auto md:max-w-xs">
          <label class="input input-bordered flex items-center gap-2">
            <input type="text" id="searchInput" class="grow" placeholder="æŒ‰æ–‡æ¡£åç§°æœç´¢..." onkeyup="searchDocuments()" />
            <i data-lucide="search" class="w-4 h-4 opacity-70"></i>
          </label>
        </div>
        <div class="relative w-full md:w-auto">
          <button class="btn btn-neutral w-full md:w-auto" onclick="triggerFileUpload('new')">
            <i data-lucide="upload-cloud" class="w-4 h-4"></i>
            ä¸Šä¼ æ–‡æ¡£
          </button>
          <button class="btn btn-xs btn-circle btn-ghost dev-note-btn shadow-lg hover:scale-110 transition-transform" style="top:0; right:0;" onclick="showDeveloperNote('note_upload_process', 'Note #1: æ–‡æ¡£ä¸Šä¼ ä¸è§£ææµç¨‹')">1</button>
        </div>
      </div>

      <!-- æ‰¹é‡æ“ä½œæ  (åŠ¨æ€æ˜¾ç¤º) -->
      <div id="batchActionBar" class="bg-base-100 p-2 rounded-lg shadow-md mb-4 flex items-center gap-4 transform scale-95 opacity-0 -translate-y-2 hidden">
        <span class="font-bold text-sm ml-2"><span id="selectedCount">0</span> å·²é€‰æ‹©</span>
        <div class="divider divider-horizontal"></div>
        <button class="btn btn-sm btn-ghost" onclick="batchEnableDocuments()">
          <i data-lucide="check-circle" class="w-4 h-4 text-success"></i>å¯ç”¨
        </button>
        <button class="btn btn-sm btn-ghost" onclick="batchDisableDocuments()">
          <i data-lucide="x-circle" class="w-4 h-4 text-warning"></i>ç¦ç”¨
        </button>
        <button class="btn btn-sm btn-ghost" onclick="batchDeleteDocuments()">
          <i data-lucide="trash-2" class="w-4 h-4 text-error"></i>åˆ é™¤
        </button>
        <div class="flex-grow"></div>
        <button class="btn btn-sm btn-ghost" onclick="clearSelection()">å–æ¶ˆ</button>
        <div class="absolute top-2 right-2">
          <button class="btn btn-xs btn-circle btn-accent shadow-lg hover:scale-110 transition-transform" onclick="showDeveloperNote('note_batch_operations', 'Note #2: æ‰¹é‡æ“ä½œçš„å¥å£®æ€§')">2</button>
        </div>
      </div>

      <!-- æ–‡æ¡£åˆ—è¡¨è¡¨æ ¼ -->
      <div class="bg-base-100 shadow-md rounded-lg overflow-x-auto">
        <table class="table table-zebra w-full">
          <thead>
            <tr>
              <th><label><input type="checkbox" id="selectAllCheckbox" class="checkbox" onchange="toggleSelectAll()" /></label></th>
              <th class="cursor-pointer hover:bg-base-200" onclick="sortTable('name')">
                æ–‡æ¡£åç§°
                <i id="sort-name" data-lucide="chevron-down" class="w-4 h-4 inline ml-1 opacity-50"></i>
              </th>
              <th class="cursor-pointer hover:bg-base-200" onclick="sortTable('status')">
                çŠ¶æ€
                <i id="sort-status" data-lucide="chevron-down" class="w-4 h-4 inline ml-1 opacity-50"></i>
              </th>
              <th class="text-center">å¿«é€Ÿå¯ç”¨/ç¦ç”¨</th>
              <th class="text-center cursor-pointer hover:bg-base-200" onclick="sortTable('items')">
                ğŸ§© çŸ¥è¯†æ¡ç›®æ•°
                <i id="sort-items" data-lucide="chevron-down" class="w-4 h-4 inline ml-1 opacity-50"></i>
              </th>
              <th class="cursor-pointer hover:bg-base-200" onclick="sortTable('upload')">
                ğŸ•’ ä¸Šä¼ æ—¶é—´
                <i id="sort-upload" data-lucide="chevron-down" class="w-4 h-4 inline ml-1 opacity-50"></i>
              </th>
              <th class="cursor-pointer hover:bg-base-200" onclick="sortTable('update')">
                ğŸ•’ æœ€åæ›´æ–°
                <i id="sort-update" data-lucide="chevron-down" class="w-4 h-4 inline ml-1 opacity-50"></i>
              </th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            <!-- ç¤ºä¾‹è¡Œ 1: å·²å¯ç”¨ -->
            <tr data-doc-id="doc_001" data-status="enabled">
              <td><label><input type="checkbox" class="checkbox document-checkbox" data-doc-id="doc_001" onchange="handleDocumentSelection()" /></label></td>
              <td><a href="./P_022_knowledge_item_list.html" class="link link-hover font-medium flex items-center gap-2">â¡ï¸ å®‰è£…æŒ‡å—.md</a></td>
              <td><div class="badge badge-success badge-outline gap-1">å·²å¯ç”¨</div></td>
              <td class="text-center"><input type="checkbox" class="toggle toggle-success" checked onchange="toggleDocumentStatus('doc_001', this)" /></td>
              <td class="text-center">150</td>
              <td>3å¤©å‰</td>
              <td>2å¤©å‰, by å°å¼ </td>
              <td class="flex items-center gap-1">
                <div class="dropdown dropdown-end">
                    <button tabindex="0" role="button" class="btn btn-sm btn-ghost btn-circle"><i data-lucide="settings" class="w-4 h-4"></i></button>
                    <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                        <li><a class="whitespace-nowrap" onclick="triggerFileUpload('update', 'doc_001')">æ›´æ–°æ–‡æ¡£</a></li>
                        <li><a class="whitespace-nowrap" onclick="renameDocument('doc_001')">é‡å‘½å</a></li>
                    </ul>
                </div>
                <button class="btn btn-sm btn-ghost btn-circle text-error" onclick="confirmDeleteDocument('doc_001', 'å®‰è£…æŒ‡å—.md')"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
              </td>
            </tr>
            <!-- ç¤ºä¾‹è¡Œ 2: å·²å¯ç”¨ -->
            <tr data-doc-id="doc_002" data-status="enabled">
              <td><label><input type="checkbox" class="checkbox document-checkbox" data-doc-id="doc_002" onchange="handleDocumentSelection()" /></label></td>
              <td><a href="./P_022_knowledge_item_list.html" class="link link-hover font-medium flex items-center gap-2">â¡ï¸ åŠŸèƒ½åˆ—è¡¨.txt</a></td>
              <td><div class="badge badge-success badge-outline gap-1">å·²å¯ç”¨</div></td>
              <td class="text-center"><input type="checkbox" class="toggle toggle-success" checked onchange="toggleDocumentStatus('doc_002', this)" /></td>
              <td class="text-center">88</td>
              <td>1å¤©å‰</td>
              <td>5å°æ—¶å‰, by ç‹...</td>
              <td class="flex items-center gap-1">
                <div class="dropdown dropdown-end">
                    <button tabindex="0" role="button" class="btn btn-sm btn-ghost btn-circle"><i data-lucide="settings" class="w-4 h-4"></i></button>
                    <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                        <li><a class="whitespace-nowrap" onclick="triggerFileUpload('update', 'doc_002')">æ›´æ–°æ–‡æ¡£</a></li>
                        <li><a class="whitespace-nowrap" onclick="renameDocument('doc_002')">é‡å‘½å</a></li>
                    </ul>
                </div>
                <button class="btn btn-sm btn-ghost btn-circle text-error" onclick="confirmDeleteDocument('doc_002', 'åŠŸèƒ½åˆ—è¡¨.txt')"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
              </td>
            </tr>
            <!-- ç¤ºä¾‹è¡Œ 3: å·²ç¦ç”¨ -->
            <tr data-doc-id="doc_003" data-status="disabled">
              <td><label><input type="checkbox" class="checkbox document-checkbox" data-doc-id="doc_003" onchange="handleDocumentSelection()" /></label></td>
              <td><a href="./P_022_knowledge_item_list.html" class="link link-hover font-medium flex items-center gap-2">â¡ï¸ APIå‚è€ƒ.md</a></td>
              <td><div class="badge badge-outline gap-1">å·²ç¦ç”¨</div></td>
              <td class="text-center"><input type="checkbox" class="toggle toggle-success" onchange="toggleDocumentStatus('doc_003', this)" /></td>
              <td class="text-center">230</td>
              <td>2å‘¨å‰</td>
              <td>1å‘¨å‰, by æå·¥</td>
              <td class="flex items-center gap-1">
                 <div class="dropdown dropdown-end">
                    <button tabindex="0" role="button" class="btn btn-sm btn-ghost btn-circle"><i data-lucide="settings" class="w-4 h-4"></i></button>
                    <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                        <li><a class="whitespace-nowrap" onclick="triggerFileUpload('update', 'doc_003')">æ›´æ–°æ–‡æ¡£</a></li>
                        <li><a class="whitespace-nowrap" onclick="renameDocument('doc_003')">é‡å‘½å</a></li>
                    </ul>
                </div>
                <button class="btn btn-sm btn-ghost btn-circle text-error" onclick="confirmDeleteDocument('doc_003', 'APIå‚è€ƒ.md')"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
              </td>
            </tr>
            <!-- ç¤ºä¾‹è¡Œ 5: è§£æå¤±è´¥ (UXDæ–°å¢çŠ¶æ€) -->
            <tr data-doc-id="doc_005" data-status="failed">
              <td><label><input type="checkbox" class="checkbox document-checkbox" data-doc-id="doc_005" onchange="handleDocumentSelection()" /></label></td>
              <td><a class="font-medium flex items-center gap-2 text-error">â¡ï¸ å†å²æ´»åŠ¨è¯´æ˜.txt</a></td>
              <td><div class="badge badge-error badge-outline gap-1">è§£æå¤±è´¥</div></td>
              <td class="text-center"><input type="checkbox" class="toggle toggle-success" disabled /></td>
              <td class="text-center">0</td>
              <td>1åˆ†é’Ÿå‰</td>
              <td>-</td>
              <td class="flex items-center gap-1">
                 <div class="dropdown dropdown-end">
                    <button tabindex="0" role="button" class="btn btn-sm btn-ghost btn-circle"><i data-lucide="settings" class="w-4 h-4"></i></button>
                    <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                        <li><a class="whitespace-nowrap" onclick="retryParseDocument('doc_005')">é‡è¯•è§£æ</a></li>
                        <li><a class="whitespace-nowrap" onclick="viewParseLog('doc_005')">æŸ¥çœ‹æ—¥å¿—</a></li>
                    </ul>
                </div>
                <button class="btn btn-sm btn-ghost btn-circle text-error" onclick="confirmDeleteDocument('doc_005', 'å†å²æ´»åŠ¨è¯´æ˜.txt')"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- åº•éƒ¨åˆ†é¡µ -->
      <div class="flex justify-center items-center gap-4 mt-6">
        <div class="join">
          <button class="join-item btn btn-sm" onclick="goToPage('prev')">Â«</button>
          <button class="join-item btn btn-sm btn-active">1</button>
          <button class="join-item btn btn-sm" onclick="goToPage(2)">2</button>
          <button class="join-item btn btn-sm" onclick="goToPage(3)">3</button>
          <button class="join-item btn btn-sm" onclick="goToPage('next')">Â»</button>
        </div>
        <span class="text-sm text-base-content/70">å…± 15 ä¸ªæ–‡æ¡£</span>
      </div>
    </div>
  </div>

  <!-- Modal: æ–‡æ¡£ä¸Šä¼ å™¨ (P_012) -->
  <dialog id="uploader_modal" class="modal">
    <div class="modal-box">
      <h3 id="uploader_modal_title" class="font-bold text-lg flex items-center gap-2"></h3>
      <div id="uploader_modal_content" class="py-4">
        <!-- JS will populate this -->
      </div>
      <div class="modal-action">
        <form method="dialog">
          <button class="btn">å–æ¶ˆ</button>
          <button id="uploader_modal_confirm_btn" class="btn btn-neutral">ç¡®è®¤</button>
        </form>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <!-- Modal: ç¡®è®¤åˆ é™¤ (P_013) -->
  <dialog id="confirm_delete_modal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg flex items-center gap-2"><i data-lucide="alert-triangle" class="text-error"></i>ç¡®è®¤åˆ é™¤</h3>
      <p class="py-4">æ‚¨ç¡®å®šè¦åˆ é™¤æ–‡æ¡£ 'å®‰è£…æŒ‡å—.md' å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼Œç›¸å…³çš„çŸ¥è¯†æ¡ç›®ä¹Ÿå°†è¢«ä¸€å¹¶åˆ é™¤ã€‚</p>
      <div class="modal-action">
        <form method="dialog">
          <button class="btn">å–æ¶ˆ</button>
          <button class="btn btn-error">ç¡®è®¤åˆ é™¤</button>
        </form>
      </div>
    </div>
     <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>
  
  <!-- Modal: å¼€å‘è€…æ³¨é‡Š (Developer Note) -->
  <dialog id="developer_note_modal" class="modal modal-bottom sm:modal-middle">
      <div class="modal-box prose">
          <h3 id="developer_note_title" class="font-bold text-lg"></h3>
          <div id="developer_note_content" class="py-4"></div>
          <div class="modal-action">
              <form method="dialog">
                  <button class="btn">å…³é—­</button>
              </form>
          </div>
      </div
      <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <!-- éšè—çš„å¼€å‘è€…æ³¨é‡Šå†…å®¹ -->
  <div id="note_upload_process" style="display:none;">
    <p>ç‚¹å‡»"ä¸Šä¼ æ–‡æ¡£"æŒ‰é’®å°†è§¦å‘ <code>P_012</code> (æ–‡æ¡£ä¸Šä¼ å™¨) æ¨¡æ€æ¡†ã€‚</p>
    <p>åç«¯éœ€å¤„ç†æ–‡ä»¶ä¸Šä¼ ã€æ ¼å¼ä¸å¤§å°æ ¡éªŒï¼Œå¹¶**è°ƒç”¨ç¬¬ä¸‰æ–¹API**è¿›è¡Œæ–‡æ¡£çš„å¼‚æ­¥è§£æå’Œåˆ‡å—ã€‚æ“ä½œæˆåŠŸåï¼Œå»ºè®®é€šè¿‡WebSocketæˆ–å®šæ—¶è½®è¯¢çš„æ–¹å¼åˆ·æ–°æ­¤åˆ—è¡¨ï¼Œå¹¶å‘ç”¨æˆ·æ˜ç¡®å›æ˜¾æˆåŠŸçŠ¶æ€ã€‚</p>
    <div class="alert alert-warning">
        <i data-lucide="alert-triangle" class="w-4 h-4"></i>
        <span>è¯·é‡ç‚¹å…³æ³¨ä¸ç¬¬ä¸‰æ–¹APIäº¤äº’çš„**å®Œæ•´æ—¥å¿—ã€é‡è¯•åŠå‘Šè­¦æœºåˆ¶** (è§PRD <code>KB-MAN-004</code> & <code>3.1.4 å¼‚å¸¸å¤„ç†</code>)ã€‚è¿™æ˜¯ç³»ç»Ÿçš„å…³é”®å¯é æ€§ä¿éšœç‚¹ã€‚</span>
    </div>
  </div>

  <div id="note_batch_operations" style="display:none;">
      <p>æ‰¹é‡æ“ä½œï¼ˆå¦‚æ‰¹é‡ç¦ç”¨/åˆ é™¤ï¼‰æ˜¯é«˜çº§åŠŸèƒ½ï¼Œå¿…é¡»å®ç°é«˜å¥å£®æ€§ã€‚</p>
      <p>ä¸€ä¸ªå…³é”®çš„å¼‚å¸¸åœºæ™¯æ˜¯**éƒ¨åˆ†å¤±è´¥**ã€‚ä¾‹å¦‚ï¼Œæ‰¹é‡ç¦ç”¨3ä¸ªæ–‡æ¡£ï¼Œå…¶ä¸­2ä¸ªæˆåŠŸï¼Œ1ä¸ªå› ç½‘ç»œæˆ–æƒé™é—®é¢˜å¤±è´¥ã€‚</p>
      <div class="alert alert-info">
        <i data-lucide="info" class="w-4 h-4"></i>
        <span>åç«¯æ¥å£åº”èƒ½è¿”å›æ¯ä¸ªæ“ä½œçš„ç‹¬ç«‹çŠ¶æ€ã€‚å‰ç«¯æ”¶åˆ°å“åº”åï¼Œéœ€æ¸…æ™°åœ°é€šçŸ¥ç”¨æˆ·å“ªäº›æˆåŠŸã€å“ªäº›å¤±è´¥ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡ä¸€ä¸ªæŒä¹…åŒ–çš„Alert Bannerï¼‰ï¼Œå¹¶é«˜äº®æ˜¾ç¤ºå¤±è´¥çš„æ¡ç›®ä»¥ä¾›ç”¨æˆ·è·Ÿè¿› (è§UXD <code>P_021</code> æ ¸å¿ƒç”¨æˆ·æ“ä½œæµ2åŠé”™è¯¯å¤„ç†éƒ¨åˆ†)ã€‚</span>
      </div>
  </div>

  <script>
    // Lucide Icons åˆå§‹åŒ–
    lucide.createIcons();

    // å…¨å±€çŠ¶æ€ç®¡ç†
    let selectedDocuments = new Set();
    let sortColumn = null;
    let sortDirection = 'asc';

    // å¼€å‘è€…æ³¨é‡ŠåŠŸèƒ½
    function showDeveloperNote(noteContentId, noteTitle) {
        const titleEl = document.getElementById('developer_note_title');
        const contentEl = document.getElementById('developer_note_content');
        const noteSourceEl = document.getElementById(noteContentId);
        const modal = document.getElementById('developer_note_modal');

        if (titleEl && contentEl && noteSourceEl && modal) {
            titleEl.textContent = noteTitle;
            contentEl.innerHTML = noteSourceEl.innerHTML;
            // é‡æ–°æ¸²æŸ“æ–°å†…å®¹ä¸­çš„ lucide-icons
            lucide.createIcons({
                context: contentEl
            });
            modal.showModal();
        }
    }

    // Toast é€šçŸ¥ç³»ç»Ÿ
    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toastContainer') || createToastContainer();
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} shadow-lg mb-2 animate-bounce`;
        toast.innerHTML = `
            <div class="flex items-center gap-2">
                <i data-lucide="${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info'}" class="w-4 h-4"></i>
                <span>${message}</span>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        lucide.createIcons({ context: toast });
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'fixed top-4 right-4 z-50 w-80';
        document.body.appendChild(container);
        return container;
    }

    // æ–‡æ¡£é€‰æ‹©å¤„ç†
    function handleDocumentSelection() {
        const checkboxes = document.querySelectorAll('.document-checkbox');
        selectedDocuments.clear();
        
        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                selectedDocuments.add(checkbox.dataset.docId);
            }
        });
        
        updateBatchActionBar();
        updateSelectAllCheckbox();
    }

    // å…¨é€‰/å–æ¶ˆå…¨é€‰
    function toggleSelectAll() {
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const documentCheckboxes = document.querySelectorAll('.document-checkbox');
        
        documentCheckboxes.forEach(checkbox => {
            if (!checkbox.disabled) {
                checkbox.checked = selectAllCheckbox.checked;
            }
        });
        
        handleDocumentSelection();
    }

    // æ›´æ–°æ‰¹é‡æ“ä½œæ 
    function updateBatchActionBar() {
        const batchActionBar = document.getElementById('batchActionBar');
        const selectedCount = document.getElementById('selectedCount');
        const count = selectedDocuments.size;
        
        selectedCount.textContent = count;
        if (count > 0) {
            batchActionBar.classList.remove('hidden');
            setTimeout(() => batchActionBar.classList.remove('scale-95', 'opacity-0', '-translate-y-2'), 10);
        } else {
            batchActionBar.classList.add('scale-95', 'opacity-0', '-translate-y-2');
            setTimeout(() => batchActionBar.classList.add('hidden'), 300);
        }
    }

    // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
    function updateSelectAllCheckbox() {
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const documentCheckboxes = document.querySelectorAll('.document-checkbox:not([disabled])');
        const checkedCount = document.querySelectorAll('.document-checkbox:not([disabled]):checked').length;
        
        if (checkedCount === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedCount === documentCheckboxes.length) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    }

    // æ¸…é™¤é€‰æ‹©
    function clearSelection() {
        const checkboxes = document.querySelectorAll('.document-checkbox');
        checkboxes.forEach(checkbox => checkbox.checked = false);
        selectedDocuments.clear();
        updateBatchActionBar();
        updateSelectAllCheckbox();
    }

    // å¿«é€Ÿå¯ç”¨/ç¦ç”¨å•ä¸ªæ–‡æ¡£
    function toggleDocumentStatus(docId, toggleElement) {
        const row = document.querySelector(`tr[data-doc-id="${docId}"]`);
        const statusBadge = row.querySelector('.badge');
        const isEnabled = toggleElement.checked;
        
        // æ¨¡æ‹ŸAPIè°ƒç”¨å»¶è¿Ÿ
        setTimeout(() => {
            if (isEnabled) {
                statusBadge.className = 'badge badge-success badge-outline gap-1';
                statusBadge.textContent = 'å·²å¯ç”¨';
                row.dataset.status = 'enabled';
                showToast(`æ–‡æ¡£å·²å¯ç”¨`);
            } else {
                statusBadge.className = 'badge badge-outline gap-1';
                statusBadge.textContent = 'å·²ç¦ç”¨';
                row.dataset.status = 'disabled';
                showToast(`æ–‡æ¡£å·²ç¦ç”¨`, 'info');
            }
        }, 300);
    }

    // æ‰¹é‡å¯ç”¨æ–‡æ¡£
    function batchEnableDocuments() {
        if (selectedDocuments.size === 0) return;
        
        const confirmMsg = `æ‚¨ç¡®å®šè¦å¯ç”¨é€‰ä¸­çš„ ${selectedDocuments.size} ä¸ªæ–‡æ¡£å—ï¼Ÿ`;
        if (!confirm(confirmMsg)) return;

        let successCount = 0;
        selectedDocuments.forEach(docId => {
            const row = document.querySelector(`tr[data-doc-id="${docId}"]`);
            const statusBadge = row.querySelector('.badge');
            const toggle = row.querySelector('.toggle');
            
            statusBadge.className = 'badge badge-success badge-outline gap-1';
            statusBadge.textContent = 'å·²å¯ç”¨';
            toggle.checked = true;
            row.dataset.status = 'enabled';
            successCount++;
        });

        clearSelection();
        showToast(`æˆåŠŸå¯ç”¨ ${successCount} ä¸ªæ–‡æ¡£`);
    }

    // æ‰¹é‡ç¦ç”¨æ–‡æ¡£
    function batchDisableDocuments() {
        if (selectedDocuments.size === 0) return;
        
        const confirmMsg = `æ‚¨ç¡®å®šè¦ç¦ç”¨é€‰ä¸­çš„ ${selectedDocuments.size} ä¸ªæ–‡æ¡£å—ï¼Ÿç¦ç”¨åï¼Œç›¸å…³çš„çŸ¥è¯†æ¡ç›®å°†æ— æ³•è¢«AIåº”ç”¨æ£€ç´¢ã€‚`;
        if (!confirm(confirmMsg)) return;

        let successCount = 0;
        selectedDocuments.forEach(docId => {
            const row = document.querySelector(`tr[data-doc-id="${docId}"]`);
            const statusBadge = row.querySelector('.badge');
            const toggle = row.querySelector('.toggle');
            
            statusBadge.className = 'badge badge-outline gap-1';
            statusBadge.textContent = 'å·²ç¦ç”¨';
            toggle.checked = false;
            row.dataset.status = 'disabled';
            successCount++;
        });

        clearSelection();
        showToast(`æˆåŠŸç¦ç”¨ ${successCount} ä¸ªæ–‡æ¡£`, 'warning');
    }

    // æ‰¹é‡åˆ é™¤æ–‡æ¡£
    function batchDeleteDocuments() {
        if (selectedDocuments.size === 0) return;
        
        const confirmMsg = `âš ï¸ å±é™©æ“ä½œï¼šæ‚¨ç¡®å®šè¦æ°¸ä¹…åˆ é™¤é€‰ä¸­çš„ ${selectedDocuments.size} ä¸ªæ–‡æ¡£å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`;
        if (!confirm(confirmMsg)) return;

        const deletedCount = selectedDocuments.size;
        selectedDocuments.forEach(docId => {
            const row = document.querySelector(`tr[data-doc-id="${docId}"]`);
            row.remove();
        });

        clearSelection();
        showToast(`æˆåŠŸåˆ é™¤ ${deletedCount} ä¸ªæ–‡æ¡£`, 'error');
    }

    // ç¡®è®¤åˆ é™¤å•ä¸ªæ–‡æ¡£
    function confirmDeleteDocument(docId, docName) {
        const modal = document.getElementById('confirm_delete_modal');
        const modalText = modal.querySelector('p');
        modalText.textContent = `æ‚¨ç¡®å®šè¦åˆ é™¤æ–‡æ¡£ '${docName}' å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼Œç›¸å…³çš„çŸ¥è¯†æ¡ç›®ä¹Ÿå°†è¢«ä¸€å¹¶åˆ é™¤ã€‚`;
        
        // ä¿å­˜å½“å‰åˆ é™¤çš„æ–‡æ¡£ä¿¡æ¯
        window.pendingDeleteDoc = { docId, docName };
        modal.showModal();
    }

    // æ‰§è¡Œåˆ é™¤æ“ä½œ
    function executeDelete() {
        if (window.pendingDeleteDoc) {
            const { docId, docName } = window.pendingDeleteDoc;
            const row = document.querySelector(`tr[data-doc-id="${docId}"]`);
            row.remove();
            showToast(`æ–‡æ¡£ '${docName}' å·²åˆ é™¤`, 'error');
            delete window.pendingDeleteDoc;
        }
    }

    // --- UPLOAD/UPDATE LOGIC ---

    // This will store the file and context for the modal confirmation
    let uploadContext = {};

    // Main function to trigger the file selection
    function triggerFileUpload(mode = 'new', docId = null) {
        // Create a file input element dynamically
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.txt,.md,.pdf';
        fileInput.style.display = 'none';
        
        fileInput.onchange = (event) => {
            const file = event.target.files[0];
            if (file) {
                prepareUploadModal(file, docId);
            }
        };
        
        document.body.appendChild(fileInput);
        fileInput.click();
        document.body.removeChild(fileInput);
    }

    // Prepares and shows the upload modal after a file is selected
    function prepareUploadModal(file, docIdForUpdate) {
        const existingDocRow = Array.from(document.querySelectorAll('tbody tr td:nth-child(2) a'))
                                    .find(a => a.textContent.trim().substring(2) === file.name);
        const fileExists = !!existingDocRow;

        const modal = document.getElementById('uploader_modal');
        const titleEl = document.getElementById('uploader_modal_title');
        const contentEl = document.getElementById('uploader_modal_content');
        const confirmBtn = document.getElementById('uploader_modal_confirm_btn');

        uploadContext = { file }; // Store context

        if (fileExists) {
            // This is an UPDATE scenario
            uploadContext.mode = 'update';
            uploadContext.docId = existingDocRow.closest('tr').dataset.docId;

            titleEl.innerHTML = `<i data-lucide="refresh-cw"></i> æ›´æ–°ç°æœ‰æ–‡æ¡£`;
            contentEl.innerHTML = `
                <div class="alert alert-warning">
                    <i data-lucide="alert-triangle"></i>
                    <span>æ–‡ä»¶ <strong>${file.name}</strong> å·²å­˜åœ¨ã€‚ç»§ç»­ä¸Šä¼ å°†è¦†ç›–ç°æœ‰å†…å®¹ã€‚</span>
                </div>
                <p class="mt-4">æ‚¨ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ</p>
            `;
            confirmBtn.textContent = 'ç¡®è®¤æ›´æ–°';
            confirmBtn.className = 'btn btn-warning';
        } else {
            // This is a NEW upload scenario
            uploadContext.mode = 'new';

            titleEl.innerHTML = `<i data-lucide="upload-cloud"></i> ä¸Šä¼ æ–°æ–‡æ¡£`;
            contentEl.innerHTML = `
                <p>æ‚¨å³å°†ä¸Šä¼ æ–°æ–‡æ¡£:</p>
                <div class="font-bold my-2 p-2 bg-base-200 rounded">${file.name}</div>
                <p class="text-xs text-base-content/70">æ”¯æŒ .txt, .md, .pdf æ ¼å¼ï¼Œæœ€å¤§ 10MBã€‚</p>
            `;
            confirmBtn.textContent = 'ç¡®è®¤ä¸Šä¼ ';
            confirmBtn.className = 'btn btn-neutral';
        }
        
        lucide.createIcons({ context: modal });
        modal.showModal();
    }

    // This function is called when the modal's confirm button is clicked
    function executeUpload() {
        const { file, mode, docId } = uploadContext;
        
        if (mode === 'new') {
            // Simulate adding a new row
            const tbody = document.querySelector('tbody');
            const newRow = document.createElement('tr');
            const newDocId = 'doc_new_' + Date.now();
            newRow.dataset.docId = newDocId;
            newRow.dataset.status = 'enabled';
            newRow.innerHTML = `
                <td><label><input type="checkbox" class="checkbox document-checkbox" data-doc-id="${newDocId}" onchange="handleDocumentSelection()" /></label></td>
                <td><a href="./P_022_knowledge_item_list.html" class="link link-hover font-medium flex items-center gap-2">â¡ï¸ ${file.name}</a></td>
                <td><div class="badge badge-success badge-outline gap-1">å·²å¯ç”¨</div></td>
                <td class="text-center"><input type="checkbox" class="toggle toggle-success" checked onchange="toggleDocumentStatus('${newDocId}', this)" /></td>
                <td class="text-center">${Math.floor(Math.random() * 100)}</td>
                <td>åˆšåˆš</td>
                <td>åˆšåˆš, by æ‚¨</td>
                <td class="flex items-center gap-1">
                    <div class="dropdown dropdown-end">
                        <button tabindex="0" role="button" class="btn btn-sm btn-ghost btn-circle"><i data-lucide="settings" class="w-4 h-4"></i></button>
                        <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                            <li><a class="whitespace-nowrap" onclick="triggerFileUpload('update', '${newDocId}')">æ›´æ–°æ–‡æ¡£</a></li>
                            <li><a class="whitespace-nowrap" onclick="renameDocument('${newDocId}')">é‡å‘½å</a></li>
                        </ul>
                    </div>
                    <button class="btn btn-sm btn-ghost btn-circle text-error" onclick="confirmDeleteDocument('${newDocId}', '${file.name}')"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </td>
            `;
            tbody.insertBefore(newRow, tbody.firstChild);
            lucide.createIcons({ context: newRow });
            showToast(`æ–‡æ¡£ '${file.name}' å·²æˆåŠŸä¸Šä¼ ã€‚`);

        } else if (mode === 'update') {
            // Simulate updating an existing row
            const row = document.querySelector(`tr[data-doc-id="${docId}"]`);
            if (row) {
                const updateCell = row.querySelector('td:nth-child(7)');
                updateCell.textContent = 'åˆšåˆš, by æ‚¨';
                
                // Animate the row to show it was updated
                row.classList.add('bg-info', 'transition-all', 'duration-1000');
                setTimeout(() => {
                    row.classList.remove('bg-info');
                }, 1500);

                showToast(`æ–‡æ¡£ '${file.name}' å·²æˆåŠŸæ›´æ–°ã€‚`);
            }
        }
        
        // Clear context after use
        uploadContext = {};
    }

    // è¡¨æ ¼æ’åº
    function sortTable(column) {
        const tbody = document.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        // æ›´æ–°æ’åºæ–¹å‘
        if (sortColumn === column) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortColumn = column;
            sortDirection = 'asc';
        }
        
        // æ’åºé€»è¾‘
        rows.sort((a, b) => {
            let aValue, bValue;
            
            switch (column) {
                case 'name':
                    aValue = a.querySelector('td:nth-child(2) a').textContent.trim();
                    bValue = b.querySelector('td:nth-child(2) a').textContent.trim();
                    break;
                case 'status':
                    aValue = a.dataset.status || 'unknown';
                    bValue = b.dataset.status || 'unknown';
                    break;
                case 'items':
                    aValue = parseInt(a.querySelector('td:nth-child(5)').textContent) || 0;
                    bValue = parseInt(b.querySelector('td:nth-child(5)').textContent) || 0;
                    break;
                case 'upload':
                case 'update':
                    // ç®€åŒ–çš„æ—¶é—´æ’åºï¼Œå®é™…åº”è¯¥è§£æå…·ä½“æ—¶é—´
                    aValue = a.querySelector(`td:nth-child(${column === 'upload' ? 6 : 7})`).textContent.trim();
                    bValue = b.querySelector(`td:nth-child(${column === 'upload' ? 6 : 7})`).textContent.trim();
                    break;
            }
            
            if (typeof aValue === 'string') {
                return sortDirection === 'asc'
                    ? aValue.localeCompare(bValue)
                    : bValue.localeCompare(aValue);
            } else {
                return sortDirection === 'asc' ? aValue - bValue : bValue - aValue;
            }
        });
        
        // é‡æ–°æ’å…¥æ’åºåçš„è¡Œ
        rows.forEach(row => tbody.appendChild(row));
        
        // æ›´æ–°æ’åºå›¾æ ‡
        updateSortIcons(column);
    }

    // æ›´æ–°æ’åºå›¾æ ‡
    function updateSortIcons(activeColumn) {
        const columns = ['name', 'status', 'items', 'upload', 'update'];
        columns.forEach(col => {
            const icon = document.getElementById(`sort-${col}`);
            if (icon) {
                if (col === activeColumn) {
                    icon.setAttribute('data-lucide', sortDirection === 'asc' ? 'chevron-up' : 'chevron-down');
                    icon.className = 'w-4 h-4 inline ml-1 opacity-100';
                } else {
                    icon.setAttribute('data-lucide', 'chevron-down');
                    icon.className = 'w-4 h-4 inline ml-1 opacity-50';
                }
            }
        });
        lucide.createIcons();
    }

    // æœç´¢åŠŸèƒ½
    function searchDocuments() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const rows = document.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            const docName = row.querySelector('td:nth-child(2) a').textContent.toLowerCase();
            if (docName.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // åˆ†é¡µåŠŸèƒ½
    function goToPage(page) {
        // æ¨¡æ‹Ÿåˆ†é¡µè·³è½¬
        console.log('è·³è½¬åˆ°é¡µé¢:', page);
        showToast(`å·²è·³è½¬åˆ°ç¬¬ ${page} é¡µ`, 'info');
    }

    // æ–‡æ¡£æ“ä½œå‡½æ•°
    function renameDocument(docId) {
        const newName = prompt('è¯·è¾“å…¥æ–°çš„æ–‡æ¡£åç§°:');
        if (newName && newName.trim()) {
            const row = document.querySelector(`tr[data-doc-id="${docId}"]`);
            const link = row.querySelector('td:nth-child(2) a');
            const deleteBtn = row.querySelector('button.text-error');
            link.textContent = `â¡ï¸ ${newName.trim()}`;
            if(deleteBtn) {
                deleteBtn.setAttribute('onclick', `confirmDeleteDocument('${docId}', '${newName.trim().replace(/'/g, "\\'")}')`);
            }
            showToast(`æ–‡æ¡£å·²é‡å‘½åä¸º "${newName.trim()}"`);
        }
    }

    function retryParseDocument(docId) {
        const row = document.querySelector(`tr[data-doc-id="${docId}"]`);
        const statusBadge = row.querySelector('.badge');
        
        // è®¾ç½®ä¸ºé‡æ–°è§£æä¸­çŠ¶æ€
        row.className = 'opacity-70';
        row.dataset.status = 'updating';
        statusBadge.className = 'badge badge-warning badge-outline gap-1';
        statusBadge.textContent = 'é‡æ–°è§£æä¸­...';
        
        showToast('å¼€å§‹é‡æ–°è§£ææ–‡æ¡£', 'info');
        
        // æ¨¡æ‹Ÿé‡æ–°è§£æ
        setTimeout(() => {
            const success = Math.random() > 0.3; // 70% æˆåŠŸç‡
            
            if (success) {
                row.className = '';
                row.dataset.status = 'enabled';
                statusBadge.className = 'badge badge-success badge-outline gap-1';
                statusBadge.textContent = 'å·²å¯ç”¨';
                
                const itemsCell = row.querySelector('td:nth-child(5)');
                itemsCell.textContent = '45';
                
                const toggle = row.querySelector('.toggle');
                toggle.disabled = false;
                toggle.checked = true;
                
                showToast('æ–‡æ¡£è§£ææˆåŠŸ');
            } else {
                row.className = '';
                row.dataset.status = 'failed';
                statusBadge.className = 'badge badge-error badge-outline gap-1';
                statusBadge.textContent = 'è§£æå¤±è´¥';
                showToast('æ–‡æ¡£è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡æ¡£æ ¼å¼', 'error');
            }
        }, 2000);
    }

    function viewParseLog(docId) {
        alert('è§£ææ—¥å¿—:\n\né”™è¯¯: æ–‡æ¡£æ ¼å¼ä¸æ”¯æŒ\næ—¶é—´: 2024-01-15 10:30:25\nå»ºè®®: è¯·ç¡®ä¿æ–‡æ¡£ä¸º .txt, .md, .pdf æ ¼å¼');
    }

    // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        // ç»‘å®šç¡®è®¤åˆ é™¤æŒ‰é’®äº‹ä»¶
        const confirmDeleteBtn = document.querySelector('#confirm_delete_modal .btn-error');
        if (confirmDeleteBtn) {
            confirmDeleteBtn.onclick = executeDelete;
        }
        
        // ç»‘å®šä¸Šä¼ ç¡®è®¤æŒ‰é’®äº‹ä»¶
        const confirmUploadBtn = document.getElementById('uploader_modal_confirm_btn');
        if (confirmUploadBtn) {
            confirmUploadBtn.onclick = executeUpload;
        }
    });
  </script>

</body>
</html>
<!-- END: P_021_document_list.html --> 
