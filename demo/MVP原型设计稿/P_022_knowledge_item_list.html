<!-- START: P_022_knowledge_item_list.html -->
<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>P_022 - çŸ¥è¯†æ¡ç›®åˆ—è¡¨é¡µ (v2)</title>
  <!-- Tailwind CSS & daisyUI -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    html { overflow-y: scroll; }
    .dev-note-btn {
      position: absolute;
      transform: translate(50%, -50%);
    }
    /* æ‰¹é‡æ“ä½œæ çš„å¹³æ»‘è¿‡æ¸¡ */
    #bulk-action-bar {
      transition: all 0.3s ease-in-out;
    }
    .dropdown-content li a {
      word-wrap: normal;
      word-break: keep-all;
      white-space: nowrap;
    }
  </style>
</head>
<body class="bg-base-200 font-sans">

  <div class="p-4 sm:p-6 md:p-8 min-h-screen">
    <div class="max-w-full mx-auto">

      <!-- é¡µé¢å¤´éƒ¨ -->
      <header class="mb-6">
        <div class="text-sm breadcrumbs">
          <ul>
            <li><a href="#"><i data-lucide="home" class="w-4 h-4"></i>&nbsp;çŸ¥è¯†åº“</a></li>
            <li><a href="./P_021_document_list.html"><i data-lucide="book-marked" class="w-4 h-4"></i>&nbsp;äº§å“Aæ‰‹å†Œ</a></li>
            <li><i data-lucide="file-text" class="w-4 h-4"></i>&nbsp;å®‰è£…æŒ‡å—.md</li>
          </ul>
        </div>
        <div class="mt-2">
            <h1 class="text-3xl font-bold text-base-content">ğŸ“„ å®‰è£…æŒ‡å—.md</h1>
            <p class="text-base-content/70 mt-1">åŒ…å« 150 ä¸ªçŸ¥è¯†æ¡ç›®ãƒ»æœ€åæ›´æ–°äº 2å¤©å‰</p>
        </div>
      </header>

      <!-- æ“ä½œä¸æœç´¢æ  -->
      <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
        <div class="form-control w-full md:w-auto md:max-w-xs relative">
          <label class="input input-bordered flex items-center gap-2">
            <input type="text" class="grow" placeholder="åœ¨150ä¸ªæ¡ç›®ä¸­æœç´¢..." />
            <i data-lucide="search" class="w-4 h-4 opacity-70"></i>
          </label>
        </div>
        <div class="flex items-center gap-2 w-full md:w-auto">
          <button class="btn btn-primary w-full md:w-auto" onclick="openEditor('new')">
            <i data-lucide="plus" class="w-4 h-4"></i>
            æ–°å»ºçŸ¥è¯†æ¡ç›®
          </button>
          <div class="divider divider-horizontal"></div>
          <div class="form-control relative">
            <label class="cursor-pointer label">
              <span class="label-text mr-2" id="doc-status-label">ğŸŸ¢ æ–‡æ¡£å·²å¯ç”¨</span>
              <input type="checkbox" class="toggle toggle-success" id="doc-status-toggle" checked />
            </label>
            <button class="btn btn-xs btn-circle btn-accent dev-note-btn shadow-lg hover:scale-110 transition-transform" style="top:0; right:-1.5rem;" onclick="showDeveloperNote('note_doc_status_toggle', 'Note #4: æ–‡æ¡£çº§çŠ¶æ€åˆ‡æ¢')">4</button>
          </div>
          <div class="dropdown dropdown-end">
            <button tabindex="0" role="button" class="btn btn-square btn-ghost">
              <i data-lucide="more-vertical" class="w-5 h-5"></i>
            </button>
            <ul tabindex="0" class="dropdown-content z-[10] menu p-2 shadow bg-base-100 rounded-box w-52">
              <li><a><i data-lucide="edit-3" class="w-4 h-4"></i> é‡å‘½åæ–‡æ¡£</a></li>
              <li><a><i data-lucide="trash-2" class="w-4 h-4 text-error"></i> åˆ é™¤æ–‡æ¡£</a></li>
            </ul>
             <button class="btn btn-xs btn-circle btn-accent dev-note-btn shadow-lg hover:scale-110 transition-transform" style="top:0; right:0;" onclick="showDeveloperNote('note_doc_actions', 'Note #1: æ–‡æ¡£çº§æ“ä½œ')">1</button>
          </div>
        </div>
      </div>

      <!-- æ¡ä»¶æ‰¹é‡æ“ä½œæ  -->
      <div id="bulk-action-bar" class="bg-base-100 p-2 rounded-lg shadow-md mb-4 flex items-center gap-4 transform scale-95 opacity-0 -translate-y-2 hidden">
        <span class="font-bold text-sm ml-2"><span id="selection-count">0</span> å·²é€‰æ‹©</span>
        <div class="divider divider-horizontal"></div>
        <button class="btn btn-sm btn-ghost"><i data-lucide="check-circle" class="w-4 h-4 text-success"></i>å¯ç”¨</button>
        <button class="btn btn-sm btn-ghost"><i data-lucide="x-circle" class="w-4 h-4 text-warning"></i>ç¦ç”¨</button>
        <button class="btn btn-sm btn-ghost"><i data-lucide="trash-2" class="w-4 h-4 text-error"></i>åˆ é™¤</button>
        <div class="flex-grow"></div>
        <button class="btn btn-sm btn-ghost" onclick="clearSelection()">å–æ¶ˆ</button>
        <div class="absolute top-2 right-2">
            <button class="btn btn-xs btn-circle btn-accent shadow-lg hover:scale-110 transition-transform" onclick="showDeveloperNote('note_bulk_actions', 'Note #2: æ‰¹é‡æ“ä½œé€»è¾‘')">2</button>
        </div>
      </div>

      <!-- çŸ¥è¯†æ¡ç›®åˆ—è¡¨ (è¡¨æ ¼å½¢å¼) -->
      <div class="overflow-x-auto bg-base-100 rounded-lg shadow-md">
        <table class="table table-zebra">
          <thead>
            <tr>
              <th class="w-12"><label><input type="checkbox" class="checkbox checkbox-primary" id="select-all-checkbox" /></label></th>
              <th>å†…å®¹ç‰‡æ®µ</th>
              <th class="w-32">çŠ¶æ€</th>
              <th class="w-40 text-right relative">
                æ“ä½œ
                <button class="btn btn-xs btn-circle btn-accent dev-note-btn shadow-lg hover:scale-110 transition-transform" style="top:1rem; right:-0.5rem;" onclick="showDeveloperNote('note_direct_actions', 'Note #3: ç›´æ¥æ“ä½œæ¨¡å¼')">3</button>
              </th>
            </tr>
          </thead>
          <tbody id="knowledge-item-list">
            <!-- JSåŠ¨æ€ç”Ÿæˆæ¡ç›® -->
          </tbody>
        </table>
      </div>

      <!-- åˆ†é¡µ -->
      <div class="flex justify-center mt-8">
        <div class="join">
          <button class="join-item btn">Â«</button>
          <button class="join-item btn btn-active">1</button>
          <button class="join-item btn">2</button>
          <button class="join-item btn">...</button>
          <button class="join-item btn">15</button>
          <button class="join-item btn">Â»</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Toast Container for Notifications -->
  <div id="toast-container" class="toast toast-top toast-center z-[100]"></div>

  <!-- Modals (reused from previous version) -->
  <dialog id="item_editor_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box w-11/12 max-w-4xl">
      <h3 id="editor_title" class="font-bold text-lg"></h3>
      <textarea id="editor_content" class="textarea textarea-bordered !w-full h-64 my-4" placeholder="åœ¨æ­¤è¾“å…¥çŸ¥è¯†æ¡ç›®å†…å®¹..."></textarea>
      <div class="modal-action mt-4 items-center justify-between">
        <small class="text-base-content/60">ğŸ’¡æç¤º: å†…å®¹å°†ç«‹å³åŒæ­¥è‡³ä¸‹æ¸¸ç³»ç»Ÿã€‚</small>
        <div>
          <button class="btn btn-ghost mr-2" onclick="closeEditor()">å–æ¶ˆ</button>
          <button id="editor_save_button" class="btn btn-primary">
            <span class="loading loading-spinner loading-sm hidden"></span>
            <span>âœ… ä¿å­˜å¹¶åŒæ­¥</span>
          </button>
        </div>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button type="button" onclick="closeEditor()">close</button></form>
  </dialog>
  
  <dialog id="confirm_discard_modal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg">æ”¾å¼ƒæ›´æ”¹?</h3>
      <p class="py-4">æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦æ”¾å¼ƒå—ï¼Ÿ</p>
      <div class="modal-action">
        <button class="btn" onclick="discardModal.close()">å–æ¶ˆ</button>
        <button class="btn btn-error" onclick="forceCloseEditor()">æ”¾å¼ƒ</button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button onclick="discardModal.close()">close</button></form>
  </dialog>

  <dialog id="confirm_delete_modal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg text-error"><i data-lucide="alert-triangle" class="inline-block w-5 h-5"></i> ç¡®è®¤åˆ é™¤</h3>
      <p class="py-4">æ‚¨ç¡®å®šè¦åˆ é™¤è¿™ä¸ªçŸ¥è¯†æ¡ç›®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚</p>
      <div class="modal-action">
        <button class="btn" onclick="document.getElementById('confirm_delete_modal').close()">å–æ¶ˆ</button>
        <button class="btn btn-error" id="confirm-delete-btn">ç¡®è®¤åˆ é™¤</button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <!-- Modal: å¼€å‘è€…æ³¨é‡Š (Developer Note) -->
  <dialog id="developer_note_modal" class="modal modal-bottom sm:modal-middle">
      <div class="modal-box prose">
          <h3 id="developer_note_title" class="font-bold text-lg"></h3>
          <div id="developer_note_content" class="py-4"></div>
          <div class="modal-action">
              <form method="dialog"><button class="btn">å…³é—­</button></form>
          </div>
      </div>
      <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <!-- éšè—çš„å¼€å‘è€…æ³¨é‡Šå†…å®¹ -->
  <div id="note_doc_actions" style="display:none;">
    <h4>ç”¨æˆ·æ•…äº‹</h4>
    <p>ä½œä¸ºçŸ¥è¯†åº“ç®¡ç†å‘˜ï¼Œæˆ‘å¸Œæœ›èƒ½ç›´æ¥åœ¨å½“å‰é¡µé¢å¯¹æ•´ä¸ªæ–‡æ¡£è¿›è¡Œé‡å‘½åæˆ–åˆ é™¤ï¼Œè€Œä¸éœ€è¦è¿”å›ä¸Šä¸€çº§åˆ—è¡¨ï¼Œä»¥æé«˜ç®¡ç†æ•ˆç‡ã€‚</p>
    <h4>æ ¸å¿ƒä¸šåŠ¡è§„åˆ™</h4>
    <ul>
      <li><strong>é‡å‘½å:</strong> ç‚¹å‡»åï¼Œé¡µé¢ä¸»æ ‡é¢˜ (H1) åº”å˜ä¸ºå¯ç¼–è¾‘çŠ¶æ€ã€‚</li>
      <li><strong>åˆ é™¤:</strong> å¿…é¡»è§¦å‘ä¸€ä¸ªé«˜é£é™©æ“ä½œçš„äºŒæ¬¡ç¡®è®¤æ¨¡æ€æ¡†ï¼Œæ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·å°†åˆ é™¤æ•´ä¸ªæ–‡æ¡£åŠå…¶åŒ…å«çš„æ‰€æœ‰çŸ¥è¯†æ¡ç›®ã€‚</li>
    </ul>
  </div>
  <div id="note_bulk_actions" style="display:none;">
    <h4>ç”¨æˆ·æ•…äº‹</h4>
    <p>ä½œä¸ºå†…å®¹ç»´æŠ¤è€…ï¼Œæˆ‘éœ€è¦ä¸€æ¬¡æ€§å¯ç”¨æˆ–ç¦ç”¨å¤šä¸ªç›¸å…³çš„çŸ¥è¯†æ¡ç›®ï¼ˆä¾‹å¦‚ï¼Œæ‰€æœ‰å…³äºæŸä¸ªæ—§åŠŸèƒ½çš„æ¡ç›®ï¼‰ï¼Œä»¥å¿«é€Ÿå“åº”äº§å“è¿­ä»£ã€‚</p>
    <h4>æ ¸å¿ƒä¸šåŠ¡è§„åˆ™</h4>
    <ul>
      <li>æ­¤æ“ä½œæ ä»…åœ¨ç”¨æˆ·é€‰ä¸­è‡³å°‘ä¸€ä¸ªæ¡ç›®æ—¶æ‰å‡ºç°ã€‚</li>
      <li>æ“ä½œæ åº”å¹³æ»‘åœ°å‡ºç°å’Œæ¶ˆå¤±ï¼Œè€Œä¸æ˜¯ç¬é—´åˆ‡æ¢ã€‚</li>
      <li>æ“ä½œæ ä¸Šæ˜¾ç¤ºçš„å·²é€‰æ•°é‡å¿…é¡»å®æ—¶æ›´æ–°ã€‚</li>
      <li>æ‰¹é‡åˆ é™¤æ“ä½œåŒæ ·éœ€è¦äºŒæ¬¡ç¡®è®¤ã€‚</li>
    </ul>
  </div>
  <div id="note_direct_actions" style="display:none;">
    <h4>ç”¨æˆ·æ•…äº‹</h4>
    <p>ä½œä¸ºç¼–è¾‘ï¼Œæˆ‘éœ€è¦å¿«é€Ÿåœ°å¯¹å•ä¸ªçŸ¥è¯†æ¡ç›®è¿›è¡Œå¾®è°ƒï¼ˆå¦‚ä¿®æ”¹é”™åˆ«å­—ã€åˆ‡æ¢å…¶å¯ç”¨çŠ¶æ€ï¼‰ï¼Œæˆ‘å¸Œæœ›è¿™äº›å¸¸ç”¨æ“ä½œçš„å…¥å£å§‹ç»ˆå¯è§ï¼Œæ— éœ€ä»»ä½•æ‚¬åœæˆ–é¢å¤–ç‚¹å‡»ã€‚</p>
    <h4>æ ¸å¿ƒä¸šåŠ¡è§„åˆ™</h4>
    <ul>
      <li><strong>çŠ¶æ€åˆ‡æ¢ (ğŸ”›):</strong> ç‚¹å‡»ååº”ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€äºŒæ¬¡ç¡®è®¤ï¼Œä»¥ä¾¿å¿«é€Ÿæ“ä½œã€‚UIçŠ¶æ€ï¼ˆæ ‡ç­¾ã€æ ·å¼ï¼‰å¿…é¡»åŒæ­¥æ›´æ–°ã€‚</li>
      <li><strong>ç¼–è¾‘ (âœï¸):</strong> ç‚¹å‡»åæ‰“å¼€æ ‡å‡†çš„çŸ¥è¯†æ¡ç›®ç¼–è¾‘å™¨æ¨¡æ€æ¡†ã€‚</li>
      <li><strong>åˆ é™¤ (ğŸ—‘ï¸):</strong> å¿…é¡»æœ‰äºŒæ¬¡ç¡®è®¤ï¼Œé˜²æ­¢è¯¯æ“ä½œã€‚è¿™æ˜¯ç³»ç»Ÿçš„ã€å®¹é”™æ€§ã€‘åŸåˆ™ä½“ç°ã€‚</li>
    </ul>
  </div>
   <div id="note_doc_status_toggle" style="display:none;">
    <h4>ç”¨æˆ·æ•…äº‹</h4>
    <p>ä½œä¸ºç®¡ç†å‘˜ï¼Œæˆ‘å¸Œæœ›èƒ½ä¸€é”®ç¦ç”¨æ•´ä¸ªæ–‡æ¡£çš„æ‰€æœ‰çŸ¥è¯†ï¼Œä»¥ä¾¿è¿›è¡Œé›†ä¸­ä¿®æ”¹ï¼Œé¿å…è¢«AIè°ƒç”¨ã€‚åŒæ ·ï¼Œæˆ‘ä¹Ÿå¸Œæœ›èƒ½ä¸€é”®æ¢å¤ã€‚</p>
    <h4>æ ¸å¿ƒä¸šåŠ¡è§„åˆ™</h4>
    <ul>
      <li><strong>ä¸»æ§å¼€å…³:</strong> æ­¤å¼€å…³ä¸ºæ€»é—¸ã€‚å…³é—­æ—¶ï¼Œæ‰€æœ‰æ¡ç›®å¼ºåˆ¶ç¦ç”¨ï¼Œä¸”å•ä¸ªæ¡ç›®çš„å¼€å…³å¤±æ•ˆã€‚</li>
      <li><strong>çŠ¶æ€æ¢å¤:</strong> é‡æ–°æ‰“å¼€æ€»é—¸æ—¶ï¼Œæ¯ä¸ªæ¡ç›®åº”æ¢å¤åˆ°å®ƒè¢«æ€»é—¸å…³é—­å‰çš„å„è‡ªçŠ¶æ€ã€‚</li>
      <li><strong>åå‘åŒæ­¥:</strong> å½“æ€»é—¸å¼€å¯æ—¶ï¼Œå¦‚æœç”¨æˆ·æ‰‹åŠ¨å¯ç”¨äº†ä»»ä½•ä¸€ä¸ªæ¡ç›®ï¼Œæ€»é—¸å¿…é¡»è‡ªåŠ¨ä¿æŒ/åˆ‡æ¢ä¸ºå¼€å¯çŠ¶æ€ã€‚</li>
    </ul>
  </div>

  <script>
    // --- åˆå§‹æ•°æ®å’ŒçŠ¶æ€ ---
    let knowledgeItems = [
        { id: 1, content: 'åœ¨å®‰è£…å‰ï¼Œè¯·ç¡®ä¿æ‚¨çš„æ“ä½œç³»ç»Ÿä¸º Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œå¹¶ä¸”æ‹¥æœ‰ç®¡ç†å‘˜æƒé™ã€‚', enabled: true, lastEnabledState: true },
        { id: 2, content: 'ä¸‹è½½æœ€æ–°çš„ .exe å®‰è£…åŒ…ï¼ŒåŒå‡»è¿è¡Œå¹¶æŒ‰ç…§å‘å¯¼æç¤ºæ“ä½œã€‚è¯·ç¡®ä¿å‹¾é€‰â€œæ·»åŠ åˆ°ç³»ç»Ÿè·¯å¾„â€ã€‚', enabled: true, lastEnabledState: true },
        { id: 3, content: 'é¦–å…ˆï¼Œè¯·ç¡®ä¿æ‚¨å·²å®‰è£… Homebrewã€‚æ‰“å¼€ç»ˆç«¯å¹¶è¿è¡Œ `brew install our-app`ã€‚æ­¤æ–¹æ³•ä»…é€‚ç”¨äºmacOSã€‚', enabled: false, lastEnabledState: false },
        { id: 4, content: 'å¯¹äºLinuxç”¨æˆ·ï¼Œæˆ‘ä»¬æä¾›äº†AppImageåŒ…ã€‚ä¸‹è½½åèµ‹äºˆå…¶æ‰§è¡Œæƒé™å³å¯è¿è¡Œï¼š`chmod +x our-app.AppImage`', enabled: true, lastEnabledState: true },
        { id: 5, content: 'æ—§ç‰ˆçš„é…ç½®æ–‡ä»¶ä½äº `~/.config/old-app`ï¼Œæ–°ç‰ˆå°†è‡ªåŠ¨è¿ç§»ã€‚', enabled: false, lastEnabledState: false },
    ];
    let selectedItems = new Set();
    let isDocumentEnabled = true;

    // --- DOM å…ƒç´ å¼•ç”¨ ---
    const listContainer = document.getElementById('knowledge-item-list');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const bulkActionBar = document.getElementById('bulk-action-bar');
    const selectionCountEl = document.getElementById('selection-count');
    const editorModal = document.getElementById('item_editor_modal');
    const editorTitle = document.getElementById('editor_title');
    const editorContent = document.getElementById('editor_content');
    const saveButton = document.getElementById('editor_save_button');
    const discardModal = document.getElementById('confirm_discard_modal');
    const deleteModal = document.getElementById('confirm_delete_modal');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const docStatusToggle = document.getElementById('doc-status-toggle');
    const docStatusLabel = document.getElementById('doc-status-label');
    const toastContainer = document.getElementById('toast-container');

    let isContentChanged = false;
    let originalContent = '';
    let itemToDelete = null;

    // --- API æ¨¡æ‹Ÿä¸é€šçŸ¥ ---
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `alert ${type === 'success' ? 'alert-success' : 'alert-error'} shadow-lg`;
        toast.innerHTML = `
          <div class="flex items-center">
            <i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="w-5 h-5 mr-2"></i>
            <span>${message}</span>
          </div>
        `;
        
        toastContainer.appendChild(toast);
        lucide.createIcons({ context: toast });

        // Fade in animation
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(-20px)';
        requestAnimationFrame(() => {
            toast.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            toast.style.opacity = '1';
            toast.style.transform = 'translateY(0)';
        });

        // Fade out and remove
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(20px)';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function simulateApiCall(operation) {
        console.log(`Simulating API call for: ${operation}`);
        return new Promise((resolve, reject) => {
            const success = Math.random() > 0.2; // 80% success rate
            const delay = 400 + Math.random() * 600;

            setTimeout(() => {
                if (success) {
                    console.log(`API call for ${operation} SUCCEEDED.`);
                    resolve({ status: 'ok', message: 'æ“ä½œæˆåŠŸ' });
                } else {
                    console.error(`API call for ${operation} FAILED.`);
                    reject(new Error('ç½‘ç»œé”™è¯¯ï¼šæ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚'));
                }
            }, delay);
        });
    }

    // --- æ¸²æŸ“å‡½æ•° ---
    function renderList() {
        listContainer.innerHTML = '';
        knowledgeItems.forEach(item => {
            const row = document.createElement('tr');
            row.dataset.itemId = item.id;
            const isItemDisabledByDoc = !isDocumentEnabled;
            if (!item.enabled || isItemDisabledByDoc) {
                row.classList.add('opacity-60');
            }

            const statusBadge = item.enabled && isDocumentEnabled
                ? `<div class="badge badge-success badge-outline gap-1">ğŸŸ¢ å·²å¯ç”¨</div>`
                : `<div class="badge badge-warning badge-outline gap-1">ğŸ”´ å·²ç¦ç”¨</div>`;
            
            const toggleIcon = item.enabled ? 'toggle-left' : 'toggle-right';

            row.innerHTML = `
                <td><label><input type="checkbox" class="checkbox checkbox-primary item-checkbox" data-id="${item.id}" ${selectedItems.has(item.id) ? 'checked' : ''} /></label></td>
                <td class="cursor-pointer hover:bg-base-200" ondblclick="openEditor('edit', ${item.id})"><p class="text-sm text-base-content/80">${item.content}</p></td>
                <td>${statusBadge}</td>
                <td class="text-right space-x-1">
                    <div class="tooltip" data-tip="åˆ‡æ¢çŠ¶æ€">
                        <button class="btn btn-xs btn-ghost" onclick="toggleStatus(${item.id})" ${isItemDisabledByDoc ? 'disabled' : ''}><i data-lucide="${toggleIcon}" class="w-4 h-4"></i></button>
                    </div>
                    <div class="tooltip" data-tip="ç¼–è¾‘">
                        <button class="btn btn-xs btn-ghost" onclick="openEditor('edit', ${item.id})"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                    </div>
                    <div class="tooltip" data-tip="åˆ é™¤">
                        <button class="btn btn-xs btn-ghost text-error" onclick="requestDelete(${item.id})"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </td>
            `;
            listContainer.appendChild(row);
        });
        lucide.createIcons();
        updateBulkActionBar();
        updateDocStatusUI();
    }

    // --- äº¤äº’é€»è¾‘ ---
    function updateBulkActionBar() {
        const count = selectedItems.size;
        selectionCountEl.textContent = count;
        if (count > 0) {
            bulkActionBar.classList.remove('hidden');
            setTimeout(() => bulkActionBar.classList.remove('scale-95', 'opacity-0', '-translate-y-2'), 10);
        } else {
            bulkActionBar.classList.add('scale-95', 'opacity-0', '-translate-y-2');
            setTimeout(() => bulkActionBar.classList.add('hidden'), 300);
        }
        selectAllCheckbox.checked = count > 0 && count === knowledgeItems.length;
    }

    function clearSelection() {
        selectedItems.clear();
        renderList();
    }

    function toggleStatus(id) {
        const item = knowledgeItems.find(i => i.id === id);
        if (!item) return;

        const originalState = item.enabled;
        // Optimistic UI update
        item.enabled = !originalState;
        item.lastEnabledState = item.enabled;
        if (item.enabled) {
            isDocumentEnabled = true;
        }
        renderList();

        simulateApiCall(`toggle status for item ${id}`)
            .then(response => {
                showToast(`çŠ¶æ€æ›´æ–°æˆåŠŸ`, 'success');
            })
            .catch(error => {
                showToast(error.message, 'error');
                // Rollback on failure
                item.enabled = originalState;
                item.lastEnabledState = originalState;
                renderList();
            });
    }

    function toggleDocumentStatus() {
        isDocumentEnabled = !isDocumentEnabled;
        if (isDocumentEnabled) {
            knowledgeItems.forEach(item => item.enabled = item.lastEnabledState);
        } else {
            knowledgeItems.forEach(item => {
                item.lastEnabledState = item.enabled;
                item.enabled = false;
            });
        }
        renderList();
    }

    function updateDocStatusUI() {
        docStatusToggle.checked = isDocumentEnabled;
        docStatusLabel.textContent = isDocumentEnabled ? 'ğŸŸ¢ æ–‡æ¡£å·²å¯ç”¨' : 'ğŸ”´ æ–‡æ¡£å·²ç¦ç”¨';
        if (isDocumentEnabled) {
            docStatusToggle.classList.remove('toggle-error');
            docStatusToggle.classList.add('toggle-success');
        } else {
            docStatusToggle.classList.remove('toggle-success');
            docStatusToggle.classList.add('toggle-error');
        }
    }
    
    function requestDelete(id) {
        itemToDelete = id;
        deleteModal.showModal();
    }

    confirmDeleteBtn.onclick = () => {
        if (itemToDelete === null) return;

        const btn = confirmDeleteBtn;
        const originalText = btn.innerHTML;
        btn.innerHTML = `<span class="loading loading-spinner loading-sm"></span> åˆ é™¤ä¸­...`;
        btn.disabled = true;

        simulateApiCall(`delete item ${itemToDelete}`)
            .then(() => {
                knowledgeItems = knowledgeItems.filter(i => i.id !== itemToDelete);
                selectedItems.delete(itemToDelete);
                showToast(`æ¡ç›® #${itemToDelete} å·²æˆåŠŸåˆ é™¤ã€‚`, 'success');
                itemToDelete = null;
                deleteModal.close();
                renderList();
            })
            .catch(error => {
                showToast(error.message, 'error');
                deleteModal.close();
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
    };

    // --- äº‹ä»¶ç›‘å¬ ---
    selectAllCheckbox.addEventListener('change', (e) => {
        if (e.target.checked) {
            knowledgeItems.forEach(item => selectedItems.add(item.id));
        } else {
            selectedItems.clear();
        }
        renderList();
    });

    listContainer.addEventListener('change', (e) => {
        if (e.target.classList.contains('item-checkbox')) {
            const id = parseInt(e.target.dataset.id, 10);
            if (e.target.checked) {
                selectedItems.add(id);
            } else {
                selectedItems.delete(id);
            }
            updateBulkActionBar();
        }
    });

    docStatusToggle.addEventListener('change', toggleDocumentStatus);

    // --- ç¼–è¾‘å™¨ Modal é€»è¾‘ ---
    editorContent.addEventListener('input', () => {
        isContentChanged = editorContent.value !== originalContent;
    });

    function openEditor(mode, itemId = null) {
        let currentItem = null;
        if (mode === 'edit' && itemId) {
            currentItem = knowledgeItems.find(i => i.id === itemId);
            editorTitle.textContent = 'âœï¸ ç¼–è¾‘çŸ¥è¯†æ¡ç›®';
            editorContent.value = currentItem ? currentItem.content : '';
        } else {
            editorTitle.textContent = 'âœï¸ æ–°å»ºçŸ¥è¯†æ¡ç›®';
            editorContent.value = '';
        }
        originalContent = editorContent.value;
        isContentChanged = false;
        lucide.createIcons({ context: editorModal });
        editorModal.showModal();

        saveButton.onclick = () => {
            const btn = saveButton;
            const spinner = btn.querySelector('.loading');
            const text = btn.querySelector('span:not(.loading)');
            
            spinner.classList.remove('hidden');
            text.textContent = 'ä¿å­˜ä¸­...';
            btn.disabled = true;

            const operation = mode === 'edit' ? `update item ${itemId}` : 'create new item';
            simulateApiCall(operation)
                .then(() => {
                    if (mode === 'edit' && currentItem) {
                        currentItem.content = editorContent.value;
                        showToast(`æ¡ç›® #${itemId} å·²æˆåŠŸæ›´æ–°ã€‚`, 'success');
                    } else {
                        const newItem = { id: Date.now(), content: editorContent.value, enabled: true, lastEnabledState: true };
                        knowledgeItems.unshift(newItem);
                        showToast('æ–°æ¡ç›®å·²æˆåŠŸåˆ›å»ºã€‚', 'success');
                    }
                    forceCloseEditor();
                    renderList();
                })
                .catch(error => {
                    showToast(error.message, 'error');
                })
                .finally(() => {
                    spinner.classList.add('hidden');
                    text.textContent = 'âœ… ä¿å­˜å¹¶åŒæ­¥';
                    btn.disabled = false;
                });
        };
    }
    
    function closeEditor() {
        if (isContentChanged) {
            discardModal.showModal();
        } else {
            forceCloseEditor();
        }
    }

    function forceCloseEditor() {
        discardModal.close();
        editorModal.close();
    }

    editorModal.addEventListener('cancel', (event) => {
        event.preventDefault();
        closeEditor();
    });

    // --- å¼€å‘è€…æ³¨é‡ŠåŠŸèƒ½ ---
    function showDeveloperNote(noteContentId, noteTitle) {
        const titleEl = document.getElementById('developer_note_title');
        const contentEl = document.getElementById('developer_note_content');
        const noteSourceEl = document.getElementById(noteContentId);
        const modal = document.getElementById('developer_note_modal');

        if (titleEl && contentEl && noteSourceEl && modal) {
            titleEl.textContent = noteTitle;
            contentEl.innerHTML = noteSourceEl.innerHTML;
            lucide.createIcons({ context: contentEl });
            modal.showModal();
        }
    }

    // --- åˆå§‹åŒ– ---
    document.addEventListener('DOMContentLoaded', () => {
        renderList();
    });
  </script>

</body>
</html>
<!-- END: P_022_knowledge_item_list.html -->