## 版本：V1.0
## 1. 项目背景
本项目旨在构建一个企业级的RAG（检索增强生成）应用“燃料”生产与质量控制中心。随着大语言模型（LLM）应用从“能用”走向“好用”，其效果越来越依赖于外部知识库的质量、时效性和相关性。然而，当前普遍存在业务与技术脱节、知识更新流程低效、优化效果难以量化评估等核心痛点。
本平台的核心目标是，通过提供一个集**知识库内容管理**、**版本控制**与**效果评估**于一体的SaaS平台，赋能最懂业务的非技术人员（如知识运营、QA专家），让他们能够高效、安全地维护和优化知识库，并建立一个由量化评估驱动的、科学的AI回答质量持续优化闭环。

## 2. 模块拆分规划
依据最新的技术选型和MVP目标，我们对产品架构进行重新规划。新的架构将围绕“集成与扩展”的核心思想展开，旨在最大化复用成熟的开源能力，同时聚焦于打造差异化的、统一的用户体验。

*   **拆分逻辑阐述:**
    *   **能力来源导向:** 本次拆分直接映射了我们计划集成的两大核心技术底座。**“知识库管理”** 模块将完全围绕 `Dify` 的API能力进行构建，为其提供一个更加场景化的前端界面。而 **“AI质量与观测”** 和 **“应用观测”** 模块，则直接承接了 `coze-loop` 的核心功能，即评测与可观测性。
    *   **用户流程整合:** 虽然底层技术来自不同项目，但我们的平台会将它们整合成一个连贯的用户旅程。用户在“知识库管理”中更新知识后，可以无缝地切换到“AI质量评测”模块，使用更新后的知识库（通过API调用）来执行评测任务。
    *   **MVP聚焦:** 新的模块划分精准地对应了您提出的三点MVP目标，确保我们的开发力量聚焦在`Dify的前端实现`、`coze-loop的核心集成`以及`评测模块的API扩展`这三大关键任务上。

*   **模块拆分列表:**
    *   **1. 知识库管理 (基于 Dify)**
        *   **职责：** 作为Dify知识库的前端管理中心，为业务人员提供直观、便捷的知识库、文档及知识条目的增删改查操作界面。
        *   **核心功能 (MVP):** 通过调用Dify API，实现知识库/文档的创建与浏览、知识条目的增删改查、富文本编辑、版本控制与回滚、提交审核与发布流程。
    *   **2. 评测模块 (集成与扩展 coze-loop)**
        *   **职责：** 集成`coze-loop`的评测与Prompt工程能力，并将其扩展，打造一个强大的、支持多种评测方式的AI应用质量保证中心。
        *   **核心功能 (MVP):**
            *   集成`coze-loop`的测试集管理（问题-答案对）。
            *   集成`coze-loop`的Prompt工程与调试能力。
            *   集成`coze-loop`的自动化实验能力，批量检测测试集。
            *   **【二开需求】** 对评测功能进行扩展，使其能够支持对外部API（如Dify的聊天API或其他AI应用的API）进行批量评测。
    *   **3. 系统管理**
        *   **职责：** 提供平台运行所需的基础管理功能，特别是对外部服务的集成配置。
        *   **核心功能:** 用户管理、角色管理、**Dify API配置**、**coze-loop服务配置**等。
    *   **4. 其他模块**
        *   **职责：** 提供系统基础的登录功能和独立的模型管理功能。

---

## 3. 模块详情说明

### **模块/子系统一： 3.1. 知识库管理 (基于 Dify)**

#### **3.1.1 功能性需求**
| 功能点 ID | 功能点名称 | 描述 (核心业务逻辑与规则) | 是否 MVP | 优先级 | 验收标准 (AC) |
|---|---|---|---|---|---|
| `FEAT-KB-001` | 知识库列表展示 | **1. 触发条件:** 用户登录后，点击左侧导航栏的“知识库管理”。<br>**2. 前置条件:** 用户具有访问本系统的基本权限。<br>**3. 核心处理逻辑:**<br>   - 系统通过后台服务，调用Dify的“获取知识库列表”API。<br>   - **权限过滤:** 前端或后端需要根据当前用户的角色权限，过滤Dify返回的列表，仅展示用户有权查看的知识库。<br>**4. 状态变更:** 无。<br>**5. 后置结果与输出:** 页面展示用户有权访问的知识库列表。<br>**6. 依赖关系:** Dify API、本系统权限模型。 | 是 | 高 | **界面层:**<br>- 必须仅展示当前用户有权访问的知识库。<br>**数据层:**<br>- 必须成功调用Dify的API并能根据本系统权限正确过滤数据。 |
| `FEAT-KB-002` | 创建知识库 | **1. 触发条件:** 用户点击“创建知识库”按钮。<br>**2. 前置条件:** 用户角色拥有“创建知识库”的全局权限。<br>**3. 核心处理逻辑:**<br>   - 弹窗让用户输入“知识库名称”和“描述”。<br>   - 点击确认后，调用Dify的“创建知识库”API。<br>   - 创建成功后，默认将创建者赋予该知识库的“管理员”角色。<br>**4. 状态变更:** 在Dify中新增一个知识库。<br>**5. 后置结果与输出:** 提示创建成功，并刷新知识库列表。<br>**6. 依赖关系:** Dify API。 | 是 | 高 | **业务逻辑层:**<br>- 必须能调用Dify API成功创建一个新的知识库。<br>- 知识库名称必须进行唯一性校验。<br>- 创建者必须自动成为该知识库的管理员。 |
| `FEAT-KB-003` | 为知识库分配权限 | **1. 触发条件:** 用户在知识库卡片/列表项上点击“权限管理”按钮。<br>**2. 前置条件:** 用户是该知识库的“管理员”或系统全局管理员。<br>**3. 核心处理逻辑:**<br>   - 弹出权限分配界面，可搜索并添加用户。<br>   - 针对**此知识库**绑定指定的用户。<br> - 保存后，将此权限关系存储在本系统数据库中。<br>**4. 状态变更:** 本系统中知识库与用户/角色的权限绑定关系发生变化。<br>**5. 后置结果与输出:** 提示保存成功。<br>**6. 依赖关系:** 本系统的用户和角色管理模块。 | 是 | 高 | **业务逻辑层:**<br>- 必须能将用户与特定知识库的角色进行绑定。<br>- 非知识库管理员不能访问此功能。<br>- 分配的权限必须在`FEAT-KB-001`等功能中实际生效。 |
| `FEAT-KB-004` | 文档上传 | **1. 触发条件:** 在某个知识库详情页内，用户点击“上传文档”按钮。<br>**2. 前置条件:** 用户对当前知识库拥有“编辑者”或更高权限。<br>**3. 核心处理逻辑:**<br>   - 用户选择一个或多个本地文件（如.txt, .md, .pdf）。<br>   - 系统调用Dify的“文档上传”API，将文件上传至指定的知识库ID下。<br>   - Dify将负责后续的文档解析、分段、清洗和向量化。<br>**4. 状态变更:** 在Dify的指定知识库中新增一个或多个文档。<br>**5. 后置结果与输出:** 提示上传成功，并刷新文档列表。<br>**6. 依赖关系:** Dify API。 | 是 | 高 | **界面层:**<br>- 提供文件选择和上传进度的展示。<br>**业务逻辑层:**<br>- 必须检查用户对当前知识库的上传权限。<br>- 必须能成功调用Dify的文档上传接口。 |
| `FEAT-KB-005` | 文档与条目浏览 | **1. 触发条件:** 用户点击某一个知识库。<br>**2. 前置条件:** 用户对该知识库有“查看者”或更高权限。<br>**3. 核心处理逻辑:**<br>   - 调用Dify API，获取该知识库下的所有文档列表。<br>   - 当用户点击某个文档时，调用Dify API，获取该文档下的所有知识条目。<br>**4. 状态变更:** 无。<br>**5. 后置结果与输出:** 页面展示文档和知识条目列表。<br>**6. 依赖关系:** Dify API。 | 是 | 高 | **界面层:**<br>- 点击知识库后，必须展示其包含的文档列表。<br>- 点击文档后，主内容区必须分页展示其包含的知识条目列表。 |
| `FEAT-KB-006` | 知识条目增/改 | **1. 触发条件:** 用户点击“新增条目”或条目的“编辑”按钮。<br>**2. 前置条件:** 用户对当前知识库拥有“编辑者”或更高权限。<br>**3. 核心处理逻辑:**<br>   - 系统展现一个富文本编辑器。<br>   - 用户编辑内容后点击“保存”。<br>   - 系统将编辑后的内容调用Dify的“创建/更新知识条目”API，变更立即生效。<br>**4. 状态变更:** 知识条目的内容在Dify系统中被更新或创建。<br>**5. 后置结果与输出:** API调用成功后，关闭编辑器，并刷新知识条目列表。<br>**6. 依赖关系:** Dify API。 | 是 | 高 | **业务逻辑层:**<br>- 必须检查用户对当前知识库的编辑权限。<br>- 保存操作必须直接调用Dify API使变更生效。 |
| `FEAT-KB-007` | 知识条目删除 | **1. 触发条件:** 用户点击某个知识条目的“删除”按钮。<br>**2. 前置条件:** 用户对当前知识库拥有“编辑者”或更高权限。<br>**3. 核心处理逻辑:**<br>   - 系统弹出二次确认对话框。<br>   - 用户确认后，系统调用Dify的“删除知识条目”API。<br>**4. 状态变更:** 知识条目在Dify系统中被删除。<br>**5. 后置结果与输出:** API调用成功后，在知识条目列表中移除该条目。<br>**6. 依赖关系:** Dify API。 | 是 | 高 | **业务逻辑层:**<br>- 必须检查用户对当前知识库的编辑权限。<br>- 删除前必须有用户二次确认。 |

#### **3.1.2 异常处理**
| 异常情况 | 处理方式 |
|---|---|
| 调用Dify API失败 (如网络错误、Dify服务宕机) | 在界面顶部显示一个非侵入式的全局错误提示：“知识库服务暂不可用，请稍后重试或联系管理员。” 同时，禁用所有与知识库交互的按钮。 |
| 用户上传的文档格式不被Dify支持或文件过大 | 在上传组件处显示明确的错误提示，如：“上传失败，不支持的.xxx格式文件”或“文件大小超过限制”。 |
| 用户创建知识库时，名称与现有知识库冲突 | 在输入框下方显示红色提示：“知识库名称已存在，请更换。” 创建按钮置灰，直到校验通过。 |

### **模块/子系统二： 3.2. 评测和 Prompt工程模块 (集成与扩展 coze-loop)**

#### **3.2.1 功能性需求**

| 功能点 ID | 功能点名称 | 描述 (核心业务逻辑与规则) | 是否 MVP | 优先级 | 验收标准 (AC) |
|---|---|---|---|---|---|
| `FEAT-EVAL-100` | **提示词工程** | **1. 触发条件:** 用户进入“提示词工程”。<br>**2. 前置条件:** 系统管理员已在后台配置至少一个可用的大模型服务API。<br>**3. 核心处理逻辑:**<br>   - 提供一个集成自`coze-loop`的Playground前端界面。<br>   - 用户可以在界面中输入、编辑和调试提示词（Prompt）。<br>   - 用户可以选择多个已配置的大模型，系统并行请求并将结果并排展示，以便直观对比。<br>   - 支持将调试满意的提示词进行版本化保存。<br>**4. 状态变更:** 在`coze-loop`服务中创建或更新提示词及其版本。<br>**5. 后置结果与输出:** 界面上清晰展示多模型的对比结果，并保存提示词版本。<br>**6. 依赖关系:** `coze-loop`的Playground及多模型调用服务。 | 是 | 高 | 完全参考"扣子罗盘" |
| `FEAT-EVAL-200` | **评测** | **1. 触发条件:** 用户在“评测模块”中进行评测相关的操作。<br>**2. 前置条件:** 无。<br>**3. 核心处理逻辑:**<br>   - **测试集管理:** 提供创建、编辑、删除测试集的功能。每个测试集包含多个“问题-标准答案”对，这些操作将调用`coze-loop`的对应服务。<br>   - **评估器管理:** 用户可以查看、选择`coze-loop`中预设的评估器（如准确性、相关性等维度的AI裁判）。<br>   - **执行与报告:** 用户可以选择一个`coze-loop`内建的目标（如某个版本的Prompt），一个测试集和一个评估器，发起一次评测实验。实验完成后，系统需调用`coze-loop`服务获取结果，并生成详细的单次评测报告。<br>**4. 状态变更:** 在`coze-loop`服务中增删改测试集、创建评测实验记录。<br>**5. 后置结果与输出:** 用户可以管理评测所需的数据集，并能查看每次评测的详细结果报告。<br>**6. 依赖关系:** `coze-loop`的测试集、评估器、评测执行服务。 | 是 | 高 | 完全参考"扣子罗盘" |
| `FEAT-EVAL-300` | **【二开】 支持API评测** | **1. 触发条件:** 用户在“创建评测实验”时，选择评测目标类型为“外部API”（目前官方只支持“提示词”、“扣子智能体”和“扣子工作流”）。<br>**2. 前置条件:** 已创建至少一个测试集。<br>**3. 核心处理逻辑:**<br>   - **API目标配置:** 提供界面让用户输入待测API的URL、请求方法、Headers和Body模板。Body模板中必须支持使用 `${question}` 这样的占位符来动态插入测试集中的问题。<br>   - **评测流程:** 系统后台遍历测试集，用每个问题填充API请求模板，调用该外部API，获取返回结果。<br>   - **评分与报告:** 将获取的API返回结果传递给用户选定的`coze-loop`评估器进行打分。最终生成的报告中，除了基础信息外，还需支持**版本对比**功能，允许用户选择两个不同的评测报告，系统自动高亮显示分数下降的“退步案例”。<br>**4. 状态变更:** 创建一条包含API调用详情和对比分析结果的评测实验记录。<br>**5. 后置结果与输出:** 用户可以对任意外部API进行自动化评测，并获得包含退步分析的深度对比报告。<br>**6. 依赖关系:** `coze-loop`的评估器服务，外部待测API。 | 是 | 高 | **业务逻辑层:**<br>- 必须能正确解析Body模板并填充变量来构造API请求。<br>- 必须能处理外部API调用成功、失败、超时等多种情况。<br>- 整个二次开发流程需要与`coze-loop`的原有评测流程无缝集成。 |

### **模块/子系统三： 3.3 系统管理**

#### **3.3 功能性需求**
| 功能点 ID | 功能点名称 | 描述 (核心业务逻辑与规则) | 是否 MVP | 优先级 | 验收标准 (AC) |
|---|---|---|---|---|---|
| `FEAT-SYS-001` | 用户管理 | **1. 触发条件:** 管理员点击“系统管理”->“用户管理”。<br>**2. 前置条件:** 当前用户必须是“超级管理员”角色。<br>**3. 核心处理逻辑:**<br>   - 提供一个用户列表，展示所有用户的账号、角色、状态（启用/禁用）。<br>   - 支持新增用户（设置初始密码）、编辑用户信息（分配角色）、禁用/启用用户。<br>**4. 状态变更:** 平台用户数据库中的用户记录发生变化。<br>**5. 后置结果与输出:** 界面实时反映用户列表的变化。<br>**6. 依赖关系:** 无。 | 是 | 中 | **界面层:**<br>- 可以新增、删除和禁用/启用操作界面。<br>**业务逻辑层:**<br>- 只有超级管理员能访问此功能。 |
| `FEAT-SYS-002` | 角色与权限管理 | **1. 触发条件:** 管理员点击“系统管理”->“角色管理”。<br>**2. 前置条件:** 当前用户必须是“超级管理员”角色。<br>**3. 核心处理逻辑:**<br>   - 系统预设几个核心角色：超级管理员、知识库管理员、知识库编辑者、QA专家、只读用户。<br>   - **(MVP范围外)** 支持创建自定义角色。<br>   - 管理员可以查看每个预设角色的权限范围（如哪些菜单可见，哪些按钮可点），但MVP阶段不可修改预设角色的权限。<br>**4. 状态变更:** 无（MVP阶段）。<br>**5. 后置结果与输出:** 界面清晰展示各角色的权限定义。<br>**6. 依赖关系:** 无。 | 是 | 中 | **业务逻辑层:**<br>- `FEAT-SYS-001`中分配给用户的角色，其权限必须在整个系统中实际生效。<br>- 例如，“知识库编辑者”不能访问“系统管理”模块。 |

---
### **模块/子系统四： 3.4. 其他模块**

| 功能点 ID | 功能点名称 | 描述 (核心业务逻辑与规则) | 是否 MVP | 优先级 | 验收标准 (AC) |
|---|---|---|---|---|---|
| `FEAT-MSC-001` | **登录** | **1. 触发条件:** 用户访问系统根URL且未登录。<br>**2. 前置条件:** 用户已在系统中被创建并处于“启用”状态。<br>**3. 核心处理逻辑:**<br>   - 界面提供用户名和密码输入框。<br>   - 用户提交后，后端验证凭证。<br>   - 验证成功，生成一个有时效性的Token（如JWT），并返回给前端。前端将其保存，并在后续请求的Header中携带。<br>   - 验证失败，提示用户名或密码错误。<br>**4. 状态变更:** 用户的最后登录时间被更新。<br>**5. 后置结果与输出:** 登录成功，跳转到系统主页；登录失败，停留在登录页并显示错误提示。<br>**6. 依赖关系:** 无。 | 是 | 高 | |
| `FEAT-MSC-002` | **模型管理** | **1. 触发条件:** 点击“模型管理”菜单。<br>**2. 前置条件:无 <br>**3. 核心处理逻辑:**<br>   - 点击菜单后，进入"模型管理"页面，页面展示交互直接参考`coze-loop` 平台的“模型管理”界面 | 是 | 高 | 完全参考扣子罗盘 |